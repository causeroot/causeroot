<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="d3.v2.min.js"></script>
    </head>
    <style>
    	.nodeText {
    		font-family: sans-serif;
    		font: arial;
    		font-size: 1.1em;
    	}
    	.dark {
    		fill: black;
    	}
    	.light {
    		fill: #666666;
    	}
    </style>
    <body>
        <div id="visualisation"></div>
        <script type="text/javascript">

 d3.csv("/graphs.csv", createSvgElements);

function createSvgElements(data) {


var theDomIsStupid = 'o'; // Prefix for DOM entities 

var margin = {top: 40, right: 40, bottom: 40, left: 40},
    width = 700,
    height = 500,
    halfHeight = Math.floor(height / 2),
    halfWidth = Math.floor(width / 2);

var x = pad(d3.scale.linear()
    .domain(d3.extent(data, function(d) { return xval(d); }))
    .range([0, width - margin.left - margin.right]), 40);

var y = pad(d3.scale.linear()
    .domain(d3.extent(data, function(d) { return yval(d); }))
    .range([height - margin.top - margin.bottom, 0]), 40);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "dot chart")
	.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var axisColor = '#AAAAAA';

var legend = svg.append('g').attr('class', 'nodeText light');

var xLine = svg.append("svg:line")
				.attr("class", "line")
				.attr("id", "xline")
				.attr("x1", 0)
				.attr("y1", halfHeight)
				.attr("x2", width)
				.attr("y2", halfHeight)
				.attr("stroke", axisColor);

var yLine = svg.append("svg:line")
				.attr("class", "line")
				.attr("id", "xline")
				.attr("x1", halfWidth)
				.attr("y1", 0)
				.attr("x2", halfWidth)
				.attr("y2", height)
				.attr("stroke", axisColor);

var legendX = legend.append("svg:text")
				.text('x-Axis: ');
textAppend(legendX, 'Importance');

var legendY = legend.append("svg:text")
				.text('y-Axis: ')
				.attr('dy', '20');
textAppend(legendY, 'Immediacy');

var legendS = legend.append("svg:text")
				.text('Size: ')
				.attr('dy', '40');
textAppend(legendS, 'Cost');

var legendC = legend.append('svg:text')
				.text('Color: ')
				.attr('dy', '60');
textAppend(legendC, 'Cost');

function textAppend(obj, txt) {
	obj.append('tspan').text(txt).attr('class', 'legend nodeText dark');
}

var g = svg.append("g").attr("class", "circles").selectAll("circles")
    .data(data)
    .enter().append("svg:g")
    .attr("class", "c");

var g2 = svg.append("g").attr("class", "text").selectAll("text")
    .data(data)
    .enter().append("svg:g")
    .attr("class", "c");


var txt = g2.append("svg:text")
    .attr("class", "nodeText")
    .attr("id", function(d){return idFunc(d)+'t';})
    .attr("x", function(d) {return x(xval(d));})
    .attr("y", function(d) {return y(yval(d));})
    .attr("dx", function(d) {return 3*rad(d);})
    .attr("dy", function(d) {return -3*rad(d);})
    .text(function(d) {return d['Problem Name'];})
    .attr("visibility", "hidden")
    .attr('dy', fixDYValue)
    .attr('x', fixXValue);

var circles = g.append("svg:circle")
    .attr("class", "dot")
    .attr("id", idFunc)
    .attr("cx", function(d) { return x(xval(d)); })
    .attr("cy", function(d) { return y(yval(d)); })
    .attr("r", function(d) { return 4*rad(d); })
    .attr("fill", function(d) { return cinterp(d.Cost);})
    .on("mouseover", function(){
        d3.select(".text").select('#'+this.id+'t')
                .attr("visibility","visible");})
	.on("mouseout", function(){
	    d3.select(".text").select('#'+this.id+'t')
                .attr("visibility","hidden");});



function idFunc(d) {
	return theDomIsStupid+hash(d['Problem Name']);
}

var mouseOverFunction = function () {
    var c = d3.select(this);
}

function xValueOffset(obj) {
	var rightPadding = 10;
	var textWidth = parseInt(d3.select('.text').select('#' + obj.id)[0][0]
					.getComputedTextLength()) + margin.left +
					parseInt(obj.getAttribute('dx')) + rightPadding; // additions due to padding and shift.
	var textX = parseInt(obj.getAttribute('x'));
	var textEnd = textX + textWidth;
	return Math.max(0, textEnd - width);
}
		

function fixXValue() {
	var textX = parseInt(this.getAttribute('x'));
	return textX - xValueOffset(this);
}

function fixDYValue() {
	var textDY = parseInt(this.getAttribute('dy'));
	if (xValueOffset(this)) {
		return textDY * 1.4;
	}
	return textDY;
}

function pad(scale, k) {
  var range = scale.range();
  if (range[0] > range[1]) k *= -1;
  return scale.domain([range[0] - k, range[1] + k].map(scale.invert)).nice();
}
}

/* This path interpolates along any path in color space smoothly!*/
function cinterp (t) {
    var cl = ['#285287', '#79C7D9', '#9BF2EA', '#497358', '#9DBF8E'];
    idx = Math.floor(t * (cl.length-1));
    if (idx >= (cl.length-1)) {
        return cl[cl.length-1];
    }
    if (idx <= 0) {
        return cl[0];
    }
    return d3.interpolateHsl(cl[idx],cl[idx+1])(t);
}

function xval(d) { return d.Importance }
function yval(d) { return d.Immediacy }
function rad(d) { return 10 * d.Cost }
function shapefn(d) {
    var x = xval(d);
    var y = yval(d);
    return 1-2*((x-0.5)*(x-0.5)+(y-0.5)*(y-0.5));
}

/*Simple, fast, non-secure hash*/
function hash(str) {
    var hash = 0;
	if (!str ||	 str.length == 0) return hash;
	for (i = 0; i < str.length; i++) {
		char = str.charCodeAt(i);
		hash = ((hash<<5)-hash)+char;
		hash = hash & hash; // Convert to 32bit integer
	}
	return hash;
}

</script>
</body>
</html>
